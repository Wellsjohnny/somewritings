#+SETUPFILE: ../etc/org_mode_SETUPFILE.org
#+Title: Atividade 1 - Loja de Informática

* Introdução
  Este material guiará você na execução desta atividade prática.
  O objetivo é a criação de um banco de dados relacional que suporte o
  processo de persistência de uma aplicação do tipo loja de
  informática.
  
  Nesta atividade será criado banco de dados, as tabelas os
  relacionamentos.
  
  O aluno deverá recriar esse banco de dados e enviar seu próprio
  script como resposta.

  Portanto, o aluno deverá serguir as seguintes orientações para
  criação do seu escript e conclusão da sua tarefa

  Ou seja, o script deve fazer o seguinte...
  1) Criação do banco de dados
  2) Criação das tabelas
  3) Configuração da integridade referencial
  4) Cadastro de 20 clientes
  5) Cadastro de 20 hardwares
  6) Cadastro de 20 vendas considerando que deve haver clientes que
     fizeram repetidas compras, clientes que não fizeram compras e
     hardwares que não chegaram a ser vendidos.
  7) Listar todos os clientes e todos os hardwares
  8) Listar Nomes dos clientes que não realizaram compras
  9) Listar Nomes dos clientes que realizaram compras
  10) Listar Nomes dos hardwares que não foram vendidos


* preparando o ambiente
  Essa preparação vcs não precisam fazer porque o computador de vcs já
  está comfigurado. É só pra quem estiver com um ambiente com o
  container sqlserver do docker.
  
  O que eu to fazendo aqui é só subir o container compartilhando o
  volume com os scripts que vamos usar nesta aula.

  Pra ver que os scripts estão acessíveis ao container do sqlserver, o
  código abaixo roda um ls -l na pasta /sqlscripts do container
  demostrando que os nossos scripts estão lá prontinhos pra serem
  rodados.

   #+NAME: ln sql_scripts to container sqlscripts folder
   #+BEGIN_SRC shell :session s1 :results output :exports bouth
      #starts code
      docker exec sqlserver ls -l /sqlscripts
   #+END_SRC

   #+RESULTS: ln sql_scripts to container sqlscripts folder
   #+begin_example

   total 76
   -rwxrwxr-x. 1 1000 1000   18 Mar 12 17:26 Exec_sp_databases.sql
   -rwxrwxr-x. 1 1000 1000  676 Mar 12 17:26 LojaInfo_create_table.sql
   -rwxrwxr-x. 1 1000 1000 5738 Mar 12 17:26 aula_funcoes.sql
   -rwxrwxr-x. 1 1000 1000  677 Mar 12 17:26 aula_funcoes2.sql
   -rwxrwxr-x. 1 1000 1000 3943 Mar 12 17:26 aula_funcoes_old.sql
   -rwxrwxr-x. 1 1000 1000 4520 Mar 12 17:26 aula_triggers.sql
   -rwxrwxr-x. 1 1000 1000 3162 Mar 12 17:26 aula_update_e_delete.sql
   -rwxrwxr-x. 1 1000 1000  172 Mar 12 17:26 create_constraints_tests.sql
   -rwxrwxr-x. 1 1000 1000  779 Mar 12 17:26 create_contraints.sql
   -rwxrwxr-x. 1 1000 1000   46 Mar 12 17:26 create_database.sql
   -rwxrwxr-x. 1 1000 1000 1015 Mar 12 17:26 create_tables.sql
   -rwxrwxr-x. 1 1000 1000  799 Mar 12 17:26 create_tables_tests.sql
   -rwxrwxr-x. 1 1000 1000  109 Mar 12 17:26 drop_database.sql
   -rwxrwxr-x. 1 1000 1000 1918 Mar 12 17:26 inserts.sql
   -rwxrwxr-x. 1 1000 1000 2359 Mar 12 17:26 lojainfo_sqlserver_storeprocedures.sql
   -rwxrwxr-x. 1 1000 1000  475 Mar 12 17:26 select_agregacoes.sql
   -rwxrwxr-x. 1 1000 1000 2942 Mar 12 17:26 select_vendas_por_cada_cliente.sql
   #+end_example

   Tem um monte de scripts né.. 
   Não se preocupe a gente vai vê-los com calma conforme a gente
   evolui nos assuntos que vamos ver.
   

* Criando o banco de dados
    
  Utilize esse comando no início do seu script para criar seu banco de dados.

  #+NAME:create_tables.sql
  #+INCLUDE: "./sql_scripts/create_database.sql"  :only-contents t :src sql
  
   #+NAME: create database                    
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
   #+END_SRC

   #+RESULTS: create database
   #+begin_example

   DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
   -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   lojainfo                                                                                                                                 16384 NULL                                                                                                                                                                                                                                                          
   master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
   model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
   msdb                                                                                                                                     14208 NULL                                                                                                                                                                                                                                                          
   tempdb                                                                                                                                   16384 NULL                                                                                                                                                                                                                                                          
   Msg 1801, Level 16, State 3, Server bae9e23eeffb, Line 2
   Database 'lojainfo' already exists. Choose a different database name.
   DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
   -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   lojainfo                                                                                                                                 16384 NULL                                                                                                                                                                                                                                                          
   master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
   model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
   msdb                                                                                                                                     14208 NULL                                                                                                                                                                                                                                                          
   tempdb                                                                                                                                   16384 NULL
   #+end_example


   
* Criação das tabelas
  
  Nesta sessão vamos vamos conhecer as instruções sql pra utilização do banco e criação das tabelas.  
  
  #+NAME:create_tables.sql
  #+INCLUDE: "./sql_scripts/create_tables.sql"  :only-contents t :src sql
  
  Eu rodo os scripts com o comando sqlcmd mas vc pode fazer do jeito
  simples que fazemos na sala de aula mesmo. Digita esses comandos no
  editor de scripts sql do sqlstudio manager.
  
  
   #+NAME: create tables
   #+BEGIN_SRC shell :session s1 :results output :exports both
      #starts code
      docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
      docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
      docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql
   #+END_SRC

   #+RESULTS: create tables
   #+begin_example

   Changed database context to 'master'.
   DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
   -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
   model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
   msdb                                                                                                                                     14208 NULL                                                                                                                                                                                                                                                          
   tempdb                                                                                                                                   16384 NULL                                                                                                                                                                                                                                                          
   DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
   -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   lojainfo                                                                                                                                 16384 NULL                                                                                                                                                                                                                                                          
   master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
   model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
   msdb                                                                                                                                     14208 NULL                                                                                                                                                                                                                                                          
   tempdb                                                                                                                                   16384 NULL
   Changed database context to 'lojainfo'.
   TABLE_QUALIFIER                                                                                                                  TABLE_OWNER                                                                                                                      TABLE_NAME                                                                                                                       TABLE_TYPE                       REMARKS                                                                                                                                                                                                                                                       
   -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- -------------------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

   (0 rows affected)
   #+end_example







* Testa tabelas e mostra necessidade dos relacionamentos

  Agora a gente vai demonstrar que dá pra inserir registros na nossa
  tabela inserindo e depois dando um select simples;

  Você vai aprender com esse script também que apesar de a gente ter
  nossas tabelas não dá pra usar elas ainda em uma aplicação. Pra
  comprovar isso vc vai ver o *problema sério* de inserir na
  tabela de venda, uma venda pra um cliente que não existe. :( 
  A próxima sessão dessa atividade vai mostrar como resolver isso.

  #+name: testa_tabelas
  #+begin_src sh :results output replace  :exports both
  docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
  docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
  docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql  
  docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables_tests.sql
  #+end_src

  #+RESULTS: testa_tabelas
  #+begin_example
  Changed database context to 'lojainfo'.
  ,*----*-----*----*-----*
  >>> select * from tb_clientes
  id_cliente  nome                                               endereco                                                                                             fone            email                                                                 
  ----------- -------------------------------------------------- ---------------------------------------------------------------------------------------------------- --------------- ----------------------------------------------------------------------

  (0 rows affected)
  >>>select * from tb_hardware
  id_hardware descricao                                          preco_unit           qtde_atual  qtde_minima img                                                                                                                                                                                                                                                             
  ----------- -------------------------------------------------- -------------------- ----------- ----------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  (0 rows affected)
  >>>Inserindo alguns clientes...

  (1 rows affected)
  >>>Inserindo alguns hardwares pra serem vendidos

  (1 rows affected)

  (1 rows affected)

  (1 rows affected)
  >>>Mostrando os clientes inseridos
  id_cliente  nome                                               endereco                                                                                             fone            email                                                                 
  ----------- -------------------------------------------------- ---------------------------------------------------------------------------------------------------- --------------- ----------------------------------------------------------------------
            1 jeferson                                           av eteczl 1                                                                                          11-99999-9999   email...                                                              

  (1 rows affected)
  >>>Mostrando os hardwares inseridos
  id_hardware descricao                                          preco_unit           qtde_atual  qtde_minima img                                                                                                                                                                                                                                                             
  ----------- -------------------------------------------------- -------------------- ----------- ----------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            1 gabinete                                                             50          10          10 NULL                                                                                                                                                                                                                                                            
            2 processador                                                          50          10          10 NULL                                                                                                                                                                                                                                                            
            3 placa mae                                                            50          10          10 NULL                                                                                                                                                                                                                                                            

  (3 rows affected)
  >>>  :(  Aqui temos um problema!
  >>>  inserindo uma venda pro cliente 500 sendo que o cliente 500 nao existe

  (1 rows affected)
  id_venda    id_cliente  data             vlr_total  desconto   vlr_pago  
  ----------- ----------- ---------------- ---------- ---------- ----------
            1         500       2018-10-02      80.00      10.00      70.00

  (1 rows affected)
  #+end_example



  #+INCLUDE: "./sql_scripts/create_tables_tests.sql" :src sql

    
    Entao, perceba vc que id_cliente nao tem cadastrado. Entao isso torna
    o banco inconsistente. Não queremos isso. O seu diretor não quer
    isso. Vc tem que usar uma constraint pra que o banco nao deixe isso
    acontecer, ou seja, que o banco retorne uma mensagem pra quem for o
    engraçadinho ou mal informado que for fazer isso.
  
    Então preste atenção na próxima sessão dessa atividade pra você saber
    como fazer isso blz?


* Relacionamentos

  Bom, agora a gente vai resolver aquele problema da venda pro cliente
  que não existia.
  A gente vai incluir uma constraint chamada foreign key, que vc já
  conhece, claro... lá de tlbd1.

  #+name: script_constraints
  #+begin_src sh :results output replace  :exports both
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql  
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables_tests.sql
    docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_contraints.sql
  #+end_src

  #+RESULTS: script_constraints
  #+begin_example
  Changed database context to 'lojainfo'.
  >>> Temos que remover aquela venda ERRADA
  >>> pra poder inserir a nossa FK

  (1 rows affected)
  >>> Agora sim vamos criar os relacionamentos
  >>> Listando as chaves estrangeiras em cada tabela
  >>> Vamos ver as definicoes das tabelas tb_venas e tb_vendas_itens
  Name                                                                                                                             Owner                                                                                                                            Type                            Created_datetime       
  -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------------------------- -----------------------
  tb_vendas                                                                                                                        dbo                                                                                                                              user table                      2019-07-26 19:29:10.927


  Column_name                                                                                                                      Type                                                                                                                             Computed                            Length      Prec  Scale Nullable                            TrimTrailingBlanks                  FixedLenNullInSource                Collation                                                                                                                       
  -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ----------------------------------- ----------- ----- ----- ----------------------------------- ----------------------------------- ----------------------------------- --------------------------------------------------------------------------------------------------------------------------------
  id_venda                                                                                                                         int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  id_cliente                                                                                                                       int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  data                                                                                                                             date                                                                                                                             no                                            3 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  vlr_total                                                                                                                        decimal                                                                                                                          no                                            5 8     2     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  desconto                                                                                                                         decimal                                                                                                                          no                                            5 8     2     yes                                 (n/a)                               (n/a)                               NULL                                                                                                                            
  vlr_pago                                                                                                                         decimal                                                                                                                          no                                            5 8     2     yes                                 (n/a)                               (n/a)                               NULL                                                                                                                            

  Identity                                                                                                                         Seed                                     Increment                                Not For Replication
  -------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------- ---------------------------------------- -------------------
  id_venda                                                                                                                                                                1                                        1                   0

  RowGuidCol                                                                                                                      
  --------------------------------------------------------------------------------------------------------------------------------
  No rowguidcol column defined.                                                                                                   

  Data_located_on_filegroup                                                                                                       
  --------------------------------------------------------------------------------------------------------------------------------
  PRIMARY                                                                                                                         

  index_name                                                                                                                       index_description                                                                                                                                                                                                  index_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  -------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  PK__tb_venda__4595B5ABB76915BF                                                                                                   clustered, unique, primary key located on PRIMARY                                                                                                                                                                  id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

  constraint_type                                                                                                                                                                                                                                                  constraint_name                                                                                                                  delete_action update_action status_enabled status_for_replication constraint_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------- ------------- -------------- ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  FOREIGN KEY                                                                                                                                                                                                                                                      fk_vda_cli                                                                                                                       No Action     No Action     Enabled        Is_For_Replication     id_cliente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      REFERENCES lojainfo.dbo.tb_clientes (id_cliente)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
  PRIMARY KEY (clustered)                                                                                                                                                                                                                                          PK__tb_venda__4595B5ABB76915BF                                                                                                   (n/a)         (n/a)         (n/a)          (n/a)                  id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

  Table is referenced by foreign key                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
  ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  lojainfo.dbo.tb_vendas_itens: fk_itens_vda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  No views with schema binding reference table 'tb_vendas'.
  Name                                                                                                                             Owner                                                                                                                            Type                            Created_datetime       
  -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------------------------- -----------------------
  tb_vendas_itens                                                                                                                  dbo                                                                                                                              user table                      2019-07-26 19:29:11.017


  Column_name                                                                                                                      Type                                                                                                                             Computed                            Length      Prec  Scale Nullable                            TrimTrailingBlanks                  FixedLenNullInSource                Collation                                                                                                                       
  -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ----------------------------------- ----------- ----- ----- ----------------------------------- ----------------------------------- ----------------------------------- --------------------------------------------------------------------------------------------------------------------------------
  id_item                                                                                                                          int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  id_venda                                                                                                                         int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  id_hardware                                                                                                                      int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  qtde_item                                                                                                                        int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  pco_vda                                                                                                                          decimal                                                                                                                          no                                            5 8     2     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
  total_item                                                                                                                       decimal                                                                                                                          no                                            5 8     2     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            

  Identity                                                                                                                         Seed                                     Increment                                Not For Replication
  -------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------- ---------------------------------------- -------------------
  id_item                                                                                                                                                                 1                                        1                   0

  RowGuidCol                                                                                                                      
  --------------------------------------------------------------------------------------------------------------------------------
  No rowguidcol column defined.                                                                                                   

  Data_located_on_filegroup                                                                                                       
  --------------------------------------------------------------------------------------------------------------------------------
  PRIMARY                                                                                                                         

  index_name                                                                                                                       index_description                                                                                                                                                                                                  index_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  -------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  PK__tb_venda__87C9438B5857D47A                                                                                                   clustered, unique, primary key located on PRIMARY                                                                                                                                                                  id_item                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       

  constraint_type                                                                                                                                                                                                                                                  constraint_name                                                                                                                  delete_action update_action status_enabled status_for_replication constraint_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------- ------------- -------------- ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  FOREIGN KEY                                                                                                                                                                                                                                                      fk_itens_vda                                                                                                                     No Action     No Action     Enabled        Is_For_Replication     id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      REFERENCES lojainfo.dbo.tb_vendas (id_venda)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
  PRIMARY KEY (clustered)                                                                                                                                                                                                                                          PK__tb_venda__87C9438B5857D47A                                                                                                   (n/a)         (n/a)         (n/a)          (n/a)                  id_item                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       

  No foreign keys reference table 'tb_vendas_itens', or you do not have permissions on referencing tables.
  No views with schema binding reference table 'tb_vendas_itens'.
  #+end_example

  #+INCLUDE: "./sql_scripts/create_contraints.sql"  :only-contents t :src sql

    
* Testando relacionamentos
  
  Lembra que há pouco a gente inserir uma venda pra um cliente que não
  existe? Um cliente com id = 500? Espero que sim, lê o material da
  aula direito hein...
  No script anteriro a gente configurou a integridade referencial
  entre a tabela vendas (tb_vendas) e a tabela
  (tb_vendas_itens). 
  Então *esse problema de inserir uma venda pra um cliente que não
  existe* a partir de agora não vai acontecer mais.
  
  Consultando o resultado do script, mais especificamente, a parte da
  inserção de uma venda pra um cliente que não existe, você vai ver
  que o sqlserver te avisou o seguinte:

  #+BEGIN_EXAMPLE
  Msg 547, Level 16, State 1, Server bae9e23eeffb, Line 3
    : The INSERT statement conflicted with the FOREIGN KEY constraint "fk_vda_cli". The conflict occurred in database "lojainfo", table "dbo.tb_clientes", column 'id_cliente'.
  #+END_EXAMPLE

  O que o sqlserver tá querendo te dizer é o seguinte:
  o statemente insert gerou um conflito com a FK   "fk_vda_cli"

  Obviamente não foi possível inserir essa venda *problemática*
  já que o select mostra que a tabela venda não retornou registros.
    #+name: Test_relacionamentos
    #+begin_src sh :results output replace  :exports both
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql  
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables_tests.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_contraints.sql
    docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_constraints_tests.sql
    #+end_src

    #+INCLUDE: "./sql_scripts/create_constraints_tests.sql"  :only-contents t :src sql

    #+RESULTS: Test_relacionamentos
    : Changed database context to 'lojainfo'.
    : >>>Vamos inserir denovo aquela venda pra um cliente que nao existe
    : Msg 547, Level 16, State 1, Server bae9e23eeffb, Line 3
    : The INSERT statement conflicted with the FOREIGN KEY constraint "fk_vda_cli". The conflict occurred in database "lojainfo", table "dbo.tb_clientes", column 'id_cliente'.
    : The statement has been terminated.
    : id_venda    id_cliente  data             vlr_total  desconto   vlr_pago  
    : ----------- ----------- ---------------- ---------- ---------- ----------
    : 
    : (0 rows affected)


* Agora, inserindo registros
  Nessa sessão a gente vai inserir clientes, hardwares que serão
  comprados por clientes, as vendas e os itens de cada venda.

  Na verdade vamos registrar uma compra do Jeferson, de 10 unidades de
  cada item e do carlos com 1 unidade de cada item.

  Só uma nota importante! 
  lembra que a gente tinha incluído um cliente
  só pra mostrar que nossa tabela existia e que já dava pra cadastrar
  um cliente? isso foi em uma das primeiras partes desse textp, a da criação das
  tabelas.
  
  Quando a gente insere agora todos os registros a gente apaga tudo
  que havíamos inserido antes e por isso a chave primária do primeiro
  cliente pra nós agora (que vai sser o Jefesron é 2) e não 1. Porque
  ele já não é o primeiro cliente.

  Esssa é uma oportunidade pra vc compreender agora o funcinamento de
  chaves primárias e autonumeração. 

  #+Name: Tabela de vendas...
 | vda_id | Cliente  | data       | vlr_total | desconto | vlr_pago |
 |      3 | Zezinho  | 10/02/2018 |      8471 |      100 |     8371 |
 |      4 | Luizinho | 20/02/2018 |           |          |          |

  *Tabela de itens da compra do jeferson*
  #+Name: Tabela de itens da compra do jeferson
 | id_item | id_venda | id_hardware      | qtde_item | total_ite |
 |       1 |        1 | 1 (gabinete)     |        10 |    605.00 |
 |       2 |        1 | 2 (processador)  |        10 |   3005.00 |
 |       3 |        1 | 3 (placa mae)    |        10 |   1050.00 |
 |       4 |        1 | 4 (Disco Rigido) |        10 |    809.00 |
 |       5 |        1 | 5                |        10 |   3002.00 |
 |         |          |                  |           |     8471. |
 #+TBLFM: @7$5=vsum(@2..@6

 *Tabela de itens da compra do carlos*
 #+NAME: Tabela de itens da compra do carlos
 | id_item | id_venda | id_hardware      | qtde_item | total_ite |   
 |       6 |        2 | 1 (gabinete)     |         1 |    60.50  |   
 |       7 |        2 | 2 (processador)  |         1 |    300.50 |   
 |       8 |        2 | 3 (placa mae)    |         1 |    105.00 |   
 |       9 |        2 | 4 (Disco Rigido) |         1 |     80.90 |   
 |         |          |                  |           |    1086.9 |   


 #+TBLFM: @6$5=vsum(@2..@5)

 Então o script abaixo, realiza os nossos inserts que precisamos pra
 começar a trabalhar com dados.
 
    #+name: inserts
    #+begin_src sh :results output replace  :exports both
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql  
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables_tests.sql
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_contraints.sql
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_constraints_tests.sql
        docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/inserts.sql
    #+end_src

    #+INCLUDE: "./sql_scripts/inserts.sql"  :only-contents t :src sql

    #+RESULTS: inserts
    #+begin_example
    -*-*-*-*-*-drop_database.sql-*-*-*-*-*-
    Changed database context to 'master'.
    -*-*-*-*-*-create_database.sql-*-*-*-*-*-
    >>>Exec sp_databases
    DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
    -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
    model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
    msdb                                                                                                                                     14464 NULL                                                                                                                                                                                                                                                          
    tempdb                                                                                                                                   16384 NULL                                                                                                                                                                                                                                                          
    >>>Exec sp_databases
    DATABASE_NAME                                                                                                                    DATABASE_SIZE REMARKS                                                                                                                                                                                                                                                       
    -------------------------------------------------------------------------------------------------------------------------------- ------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    lojainfo                                                                                                                                 16384 NULL                                                                                                                                                                                                                                                          
    master                                                                                                                                    6144 NULL                                                                                                                                                                                                                                                          
    model                                                                                                                                    16384 NULL                                                                                                                                                                                                                                                          
    msdb                                                                                                                                     14464 NULL                                                                                                                                                                                                                                                          
    tempdb                                                                                                                                   16384 NULL                                                                                                                                                                                                                                                          
    -*-*-*-*-*-create_tables.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    TABLE_QUALIFIER                                                                                                                  TABLE_OWNER                                                                                                                      TABLE_NAME                                                                                                                       TABLE_TYPE                       REMARKS                                                                                                                                                                                                                                                       
    -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- -------------------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

    (0 rows affected)
    -*-*-*-*-*-create_tables_tests.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    ,*----*-----*----*-----*
    >>> select * from tb_clientes
    id_cliente  nome                                               endereco                                                                                             idade       sexo fone            email                                                                 
    ----------- -------------------------------------------------- ---------------------------------------------------------------------------------------------------- ----------- ---- --------------- ----------------------------------------------------------------------

    (0 rows affected)
    >>>select * from tb_hardware
    id_hardware descricao                                          preco_unit           qtde_atual  qtde_minima img                                                                                                                                                                                                                                                             
    ----------- -------------------------------------------------- -------------------- ----------- ----------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

    (0 rows affected)
    >>>Inserindo alguns clientes...

    (1 rows affected)
    >>>Inserindo alguns hardwares pra serem vendidos

    (1 rows affected)

    (1 rows affected)

    (1 rows affected)
    >>>Mostrando os clientes inseridos
    id_cliente  nome                                               endereco                                                                                             idade       sexo fone            email                                                                 
    ----------- -------------------------------------------------- ---------------------------------------------------------------------------------------------------- ----------- ---- --------------- ----------------------------------------------------------------------
              1 NomeDeTeste                                        enderecoTeste                                                                                                 20 m    11-99999-9999   email...                                                              

    (1 rows affected)
    >>>Mostrando os hardwares inseridos
    id_hardware descricao                                          preco_unit           qtde_atual  qtde_minima img                                                                                                                                                                                                                                                             
    ----------- -------------------------------------------------- -------------------- ----------- ----------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              1 gabinete                                                             50          10          10 NULL                                                                                                                                                                                                                                                            
              2 processador                                                          50          10          10 NULL                                                                                                                                                                                                                                                            
              3 placa mae                                                            50          10          10 NULL                                                                                                                                                                                                                                                            

    (3 rows affected)
    >>>  :(  Aqui temos um problema!
    >>>  inserindo uma venda pro cliente 500 sendo que o cliente 500 nao existe

    (1 rows affected)
    id_venda    id_cliente  data             desconto
    ----------- ----------- ---------------- --------
              1         500       2018-10-02      .10

    (1 rows affected)
    -*-*-*-*-*-create_constraints.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    >>> Temos que remover aquela venda ERRADA
    >>> pra poder inserir a nossa FK

    (1 rows affected)
    >>> Agora sim vamos criar os relacionamentos
    >>> Listando as chaves estrangeiras em cada tabela
    >>> Vamos ver as definicoes das tabelas tb_venas e tb_vendas_itens
    Name                                                                                                                             Owner                                                                                                                            Type                            Created_datetime       
    -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------------------------- -----------------------
    tb_vendas                                                                                                                        dbo                                                                                                                              user table                      2019-07-27 20:30:32.700


    Column_name                                                                                                                      Type                                                                                                                             Computed                            Length      Prec  Scale Nullable                            TrimTrailingBlanks                  FixedLenNullInSource                Collation                                                                                                                       
    -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ----------------------------------- ----------- ----- ----- ----------------------------------- ----------------------------------- ----------------------------------- --------------------------------------------------------------------------------------------------------------------------------
    id_venda                                                                                                                         int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    id_cliente                                                                                                                       int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    data                                                                                                                             date                                                                                                                             no                                            3 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    desconto                                                                                                                         decimal                                                                                                                          no                                            5 2     2     yes                                 (n/a)                               (n/a)                               NULL                                                                                                                            

    Identity                                                                                                                         Seed                                     Increment                                Not For Replication
    -------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------- ---------------------------------------- -------------------
    id_venda                                                                                                                                                                1                                        1                   0

    RowGuidCol                                                                                                                      
    --------------------------------------------------------------------------------------------------------------------------------
    No rowguidcol column defined.                                                                                                   

    Data_located_on_filegroup                                                                                                       
    --------------------------------------------------------------------------------------------------------------------------------
    PRIMARY                                                                                                                         

    index_name                                                                                                                       index_description                                                                                                                                                                                                  index_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
    -------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PK__tb_venda__4595B5AB066F0E0E                                                                                                   clustered, unique, primary key located on PRIMARY                                                                                                                                                                  id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

    constraint_type                                                                                                                                                                                                                                                  constraint_name                                                                                                                  delete_action update_action status_enabled status_for_replication constraint_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------- ------------- -------------- ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    FOREIGN KEY                                                                                                                                                                                                                                                      fk_vda_cli                                                                                                                       No Action     No Action     Enabled        Is_For_Replication     id_cliente                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        REFERENCES lojainfo.dbo.tb_clientes (id_cliente)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    PRIMARY KEY (clustered)                                                                                                                                                                                                                                          PK__tb_venda__4595B5AB066F0E0E                                                                                                   (n/a)         (n/a)         (n/a)          (n/a)                  id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

    Table is referenced by foreign key                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    lojainfo.dbo.tb_vendas_itens: fk_itens_vda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    No views with schema binding reference table 'tb_vendas'.
    Name                                                                                                                             Owner                                                                                                                            Type                            Created_datetime       
    -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------------------------- -----------------------
    tb_vendas_itens                                                                                                                  dbo                                                                                                                              user table                      2019-07-27 20:30:32.780


    Column_name                                                                                                                      Type                                                                                                                             Computed                            Length      Prec  Scale Nullable                            TrimTrailingBlanks                  FixedLenNullInSource                Collation                                                                                                                       
    -------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ----------------------------------- ----------- ----- ----- ----------------------------------- ----------------------------------- ----------------------------------- --------------------------------------------------------------------------------------------------------------------------------
    id_item                                                                                                                          int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    id_venda                                                                                                                         int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    id_hardware                                                                                                                      int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    qtde_item                                                                                                                        int                                                                                                                              no                                            4 10    0     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    pco_vda                                                                                                                          decimal                                                                                                                          no                                            5 8     2     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            
    total_item                                                                                                                       decimal                                                                                                                          no                                            5 8     2     no                                  (n/a)                               (n/a)                               NULL                                                                                                                            

    Identity                                                                                                                         Seed                                     Increment                                Not For Replication
    -------------------------------------------------------------------------------------------------------------------------------- ---------------------------------------- ---------------------------------------- -------------------
    id_item                                                                                                                                                                 1                                        1                   0

    RowGuidCol                                                                                                                      
    --------------------------------------------------------------------------------------------------------------------------------
    No rowguidcol column defined.                                                                                                   

    Data_located_on_filegroup                                                                                                       
    --------------------------------------------------------------------------------------------------------------------------------
    PRIMARY                                                                                                                         

    index_name                                                                                                                       index_description                                                                                                                                                                                                  index_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
    -------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    PK__tb_venda__87C9438BAC305757                                                                                                   clustered, unique, primary key located on PRIMARY                                                                                                                                                                  id_item                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       

    constraint_type                                                                                                                                                                                                                                                  constraint_name                                                                                                                  delete_action update_action status_enabled status_for_replication constraint_keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------- ------------- -------------- ---------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    FOREIGN KEY                                                                                                                                                                                                                                                      fk_itens_hardware                                                                                                                No Action     No Action     Enabled        Is_For_Replication     id_hardware                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        REFERENCES lojainfo.dbo.tb_hardware (id_hardware)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
    FOREIGN KEY                                                                                                                                                                                                                                                      fk_itens_vda                                                                                                                     No Action     No Action     Enabled        Is_For_Replication     id_venda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        REFERENCES lojainfo.dbo.tb_vendas (id_venda)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    PRIMARY KEY (clustered)                                                                                                                                                                                                                                          PK__tb_venda__87C9438BAC305757                                                                                                   (n/a)         (n/a)         (n/a)          (n/a)                  id_item                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       

    No foreign keys reference table 'tb_vendas_itens', or you do not have permissions on referencing tables.
    No views with schema binding reference table 'tb_vendas_itens'.
    -*-*-*-*-*-create_constraints_tests.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    >>>Vamos inserir denovo aquela venda pra um cliente que nao existe
    Msg 547, Level 16, State 1, Server bae9e23eeffb, Line 3
    The INSERT statement conflicted with the FOREIGN KEY constraint "fk_vda_cli". The conflict occurred in database "lojainfo", table "dbo.tb_clientes", column 'id_cliente'.
    The statement has been terminated.
    id_venda    id_cliente  data             desconto
    ----------- ----------- ---------------- --------

    (0 rows affected)
    -*-*-*-*-*-inserts.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    >>>Lembra que a gente tinha inserido alguns registros sï¿½ pra mostrar que nossas tabelas haviam sido criadas?
    >>>Pois ï¿½. Agora vamos zerar esses registros
    >>Entao, apagando registro anteriores...

    (1 rows affected)

    (3 rows affected)

    (0 rows affected)

    (0 rows affected)
    ==============================================
    >>> Agora sim, Inserindo alguns clientes

    (5 rows affected)
    >>> select * from tb_clientes
    id_cliente  nome                                               endereco                                                                                             idade       sexo fone            email                                                                 
    ----------- -------------------------------------------------- ---------------------------------------------------------------------------------------------------- ----------- ---- --------------- ----------------------------------------------------------------------
              2 Huguinho                                           Aguia Haia 123                                                                                                20 m    11-99999-9999   hug@dom.com                                                           
              3 Zezinho                                            Aguia Haia 456                                                                                                50 m    11-99999-9999   zez@dom.com                                                           
              4 Luizinho                                           Aguia Haia 789                                                                                                60 m    11-99999-9999   lui@dom.com                                                           
              5 Monica                                             Aguia Haia 789                                                                                                30 f    11-99999-9999   mon@dom.com                                                           
              6 Luluzinha                                          Aguia Haia 789                                                                                                40 f    11-99999-9999   lulu@dom.com                                                          

    (5 rows affected)
    ==============================================
    >>> Agora inserindo alguns hardwares...

    (5 rows affected)
    select * from tb_hardware
    id_hardware descricao                                          preco_unit           qtde_atual  qtde_minima img                                                                                                                                                                                                                                                             
    ----------- -------------------------------------------------- -------------------- ----------- ----------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              4 gabinete                                                             61         100          10 NULL                                                                                                                                                                                                                                                            
              5 processador                                                         301         100          10 NULL                                                                                                                                                                                                                                                            
              6 placa m?e                                                           101         100          10 NULL                                                                                                                                                                                                                                                            
              7 Dico R?gido                                                          81         100          10 NULL                                                                                                                                                                                                                                                            
              8 Monitor                                                             300         100          10 NULL                                                                                                                                                                                                                                                            

    (5 rows affected)
    ==============================================
    Inserindo a Venda para os clientes Jeferson e Carlos
    dessa vez vamos desprezar a terceira forma normal pra simplificar.
    Msg 8115, Level 16, State 8, Server bae9e23eeffb, Line 9
    Arithmetic overflow error converting int to data type numeric.
    The statement has been terminated.
    Msg 213, Level 16, State 1, Server bae9e23eeffb, Line 9
    Column name or number of supplied values does not match table definition.
    select * from tb_vendas_itens
    id_item     id_venda    id_hardware qtde_item   pco_vda    total_item
    ----------- ----------- ----------- ----------- ---------- ----------

    (0 rows affected)
    #+end_example


* fazendo umas queries
** Select simples, join, left join


   Imagine que você quer saber cliente por cliente que esteja
   cadastrado, quais as compras que eles fizeram. Caso haja um cliente
   que não tenha vendas pra ele você também quer saber. Em outras
   palavras, vc quer uma listagem dos cliente com as vendas
   relacionadas a ele.
   Analise o código abaixo pra ver como chegamos a um sql pra resolver
   isso.
   
    #+name: vendas por cada cliente
    #+begin_src sh :results output replace  :exports both
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/drop_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_database.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables.sql  
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_tables_tests.sql
    #docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/create_contraints.sql
     docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/select_vendas_por_cada_cliente.sql
    #+end_src

    #+INCLUDE: "./sql_scripts/select_vendas_por_cada_cliente.sql"  :only-contents t :src sql

    #+RESULTS: vendas por cada cliente
    #+begin_example
    -*-*-*-*-*-select_vendas_por_cada_cliente.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    Msg 102, Level 15, State 1, Server bae9e23eeffb, Line 4
    Incorrect syntax near 'tb_clientes'.
    ##########################################################
    id_cliente  nome                                               idade       sexo endereco                                                                                             fone            email                                                                 
    ----------- -------------------------------------------------- ----------- ---- ---------------------------------------------------------------------------------------------------- --------------- ----------------------------------------------------------------------
              2 Huguinho                                                    20 m    Aguia Haia 123                                                                                       11-99999-9999   hug@dom.com                                                           
              3 Zezinho                                                     50 m    Aguia Haia 456                                                                                       11-99999-9999   zez@dom.com                                                           
              4 Luizinho                                                    60 m    Aguia Haia 789                                                                                       11-99999-9999   lui@dom.com                                                           
              5 Monica                                                      30 f    Aguia Haia 789                                                                                       11-99999-9999   mon@dom.com                                                           
              6 Luluzinha                                                   40 f    Aguia Haia 789                                                                                       11-99999-9999   lulu@dom.com                                                          

    (5 rows affected)
    ##########################################################
    Abaixo vemos as vendas mas o cliente e mostrado com id, queremos ver o nome deles

    ------------------
    Select * tb_vendas

    (1 rows affected)
    id_venda    id_cliente  data             desconto
    ----------- ----------- ---------------- --------
              3           2       2018-02-10     NULL
              4           3       2018-02-20      .10

    (2 rows affected)
    >>>>Essa query faz com que o nome do cliente apareca

    --------------------------------------------------------------------------------------------------------------
    select v.id_venda,c.nome,v.data,v.desconto from tb_vendas v join tb_clientes c on c.id_cliente = v.id_cliente;

    (1 rows affected)
    id_venda    nome                                               data             desconto
    ----------- -------------------------------------------------- ---------------- --------
              3 Huguinho                                                 2018-02-10     NULL
              4 Zezinho                                                  2018-02-20      .10

    (2 rows affected)
     >>>>> ï¿½ mas ainda nao apareceu todos os clientes e sim sï¿½ os que compraram alguma coisa.
     Pra que aparece todos os clientes, mesmo que que nao tenham vendas pra eles...
     precisamos incluï¿½los todos com left join
    IdClienteDaTblCliente IdClienteDaTblVendas nome                                              
    --------------------- -------------------- --------------------------------------------------
                        2                    2 Huguinho                                          
                        3                    3 Zezinho                                           
                        4                 NULL Luizinho                                          
                        5                 NULL Monica                                            
                        6                 NULL Luluzinha                                         

    (5 rows affected)
    >>>>>Se tem left join, tem right join, certo?
     Vamos colar do lado direito o id da venda, assim a gente sabe qual foi a venda exatamente do cliente
     Esse he um passo a caminho de se obter posteriormente qual cliente comprou qual produto
     Pensa comigo, nao da pra saber quais itens foram comprados pelo cliente sem antes identificar qual foi exatamente a venda 
     que foi feita pra ele
     o que identifica a venda he o id dela, entao vamos fazer isso
    IdClienteDaTblCliente IdClienteDaTblVendas nomeCliente                                        IdVendaDaTblVendas
    --------------------- -------------------- -------------------------------------------------- ------------------
                        2                    2 Huguinho                                                            3
                        3                    3 Zezinho                                                             4
                        4                 NULL Luizinho                                                         NULL
                        5                 NULL Monica                                                           NULL
                        6                 NULL Luluzinha                                                        NULL

    (5 rows affected)
     >>>>>> O resultado acima mostra que nem todos os registros de clientes tem uma venda associada
     quando o registro nao tem uma venda associada o IdVendaDaTblVendas ï¿½ NULL
     quando ï¿½ NULL, esse registro nao tera itens, caso contrario tera
     vamos agora fazer o join com os itens vendidos em cada venda
     que tal dar-mos uma olhada na tabela id_vendas_itens?
      Agora vai a nossa query pra mostrar do lado direito os itens de cada compra
    IdClienteDaTblCliente IdClienteDaTblVendas nomeCliente                                        IdVendaDaTblVendas idItem      idHardware  qtde       
    --------------------- -------------------- -------------------------------------------------- ------------------ ----------- ----------- -----------
                        2                    2 Huguinho                                                            3           1           4          10
                        2                    2 Huguinho                                                            3           2           5          10
                        2                    2 Huguinho                                                            3           3           6          10
                        2                    2 Huguinho                                                            3           4           7          10
                        2                    2 Huguinho                                                            3           5           8          10
                        3                    3 Zezinho                                                             4           6           4           1
                        3                    3 Zezinho                                                             4           7           5           1
                        3                    3 Zezinho                                                             4           8           6           1
                        3                    3 Zezinho                                                             4           9           7           1
                        3                    3 Zezinho                                                             4          10           8           1

    (10 rows affected)
    >>>> Bom, agora o obvio he querer saber o nome de cada item e nao o id dele
    Isso vai facilitar pro leitor saber qual he o produto pelo nome
    IdClienteDaTblCliente IdClienteDaTblVendas nomeCliente                                        IdVendaDaTblVendas idItem      idHardware  DescricaoDoProduto                                
    --------------------- -------------------- -------------------------------------------------- ------------------ ----------- ----------- --------------------------------------------------
                        2                    2 Huguinho                                                            3           1           4 gabinete                                          
                        2                    2 Huguinho                                                            3           2           5 processador                                       
                        2                    2 Huguinho                                                            3           3           6 placa m?e                                         
                        2                    2 Huguinho                                                            3           4           7 Dico R?gido                                       
                        2                    2 Huguinho                                                            3           5           8 Monitor                                           
                        3                    3 Zezinho                                                             4           6           4 gabinete                                          
                        3                    3 Zezinho                                                             4           7           5 processador                                       
                        3                    3 Zezinho                                                             4           8           6 placa m?e                                         
                        3                    3 Zezinho                                                             4           9           7 Dico R?gido                                       
                        3                    3 Zezinho                                                             4          10           8 Monitor                                           
                        4                 NULL Luizinho                                                         NULL        NULL        NULL NULL                                              
                        5                 NULL Monica                                                           NULL        NULL        NULL NULL                                              
                        6                 NULL Luluzinha                                                        NULL        NULL        NULL NULL                                              

    (13 rows affected)
    #+end_example



Perceba que o left join pegou todos os cliente cadastrados mesmo que
não houvesse registros correspondentes a eles na tabela de vendas.

Dá uma olhada com calma na saída da query [QUERY ITENS COMPRAS1].
Perceba o seguinte, como cada venda tem mais de um iten, o banco
repete o registro da venda pra cada item vendido. Mas vc percebeu que
os registros que não havia uma venda deixaram de ser mostrados?
Já na query [QUERY ITENS COMPRAS2] eles aparecem por causa do left
join.

** Select com agregacoes
Bom e se a gente quizer saber qual valor de cada venda?
Claro que o resultado que temos até agora com as nossas queries vai
ajudar muito.

De cara já dá pra perceber que agente tem que pegar agrupar pelo id da
venda. Mas e os itens? Bom o nome de cada item não dá pra mostrar já
que agora a gente vai agrupar pelo id da venda e não vai dar pro banco
repedir o id da venda pra pode mostrar cada item.
Se vc quizer mostrar o nome do iten vc vai ter um problema de lógica e
obviamente um erro do banco já que não dá pra agrupar pelo id da venda
e mostrar cada item. Mas pensando bem a gente não quer mostrar cada
iten a gente só quer fazer a soma dos valoreses de cada item e aí sim
teremos apenas um valor pra cada id de venda e aí funciona. Se tiver
dúvida aqui pergunta pro professor na aula que ele te explica melhor.
Vamos fazer isso...

    #+name: select agregacoes
    #+begin_src sh :results output replace  :exports both
      docker exec sqlserver /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P Aluno#123 -i /sqlscripts/select_agregacoes.sql
    #+end_src

    #+INCLUDE: "./sql_scripts/select_agregacoes.sql"  :only-contents t :src sql

    #+RESULTS: select agregacoes
    #+begin_example
    -*-*-*-*-*-select_agregacoes.sql-*-*-*-*-*-
    Changed database context to 'lojainfo'.
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

    -----------------------
    Select * from tb_vendas

    (1 rows affected)
    id_venda    id_cliente  data             desconto
    ----------- ----------- ---------------- --------
              3           2       2018-02-10     NULL
              4           3       2018-02-20      .10

    (2 rows affected)

    -----------------------------
    Select * from tb_vendas_itens

    (1 rows affected)
    id_item     id_venda    id_hardware qtde_item   pco_vda   
    ----------- ----------- ----------- ----------- ----------
              1           3           4          10     600.50
              2           3           5          10    3005.00
              3           3           6          10    1050.00
              4           3           7          10     809.00
              5           3           8          10    3002.00
              6           4           4           1      60.00
              7           4           5           1     300.00
              8           4           6           1     101.00
              9           4           7           1      80.00
             10           4           8           1     300.00

    (10 rows affected)
    >>>Vamos ver qual foi o valor da venda(compra) de cada cliente?
    IdVendaDaTblVendas VlrPagoPelosItens                       
    ------------------ ----------------------------------------
                     3                                  8466.50
                     4                                   841.00

    (2 rows affected)
    >>>Vamos ver qual foi o valor da venda(compra) de cada cliente?
    IdVendaDaTblVendas VlrPagoPelosItens                       
    ------------------ ----------------------------------------
                     3                                  8466.50
                     4                                   841.00

    (2 rows affected)
    >>>Agora vamos o nome dos clientes pra quem foi feita essas vendas
    Cliente                                            IdVendaDaTblVendas VlrPagoPelosItens                       
    -------------------------------------------------- ------------------ ----------------------------------------
    Huguinho                                                            3                                  8466.50
    Zezinho                                                             4                                   841.00

    (2 rows affected)
    #+end_example


* script completo
  #+INCLUDE: ./sql_scripts/aula_funcoes.sql src sql 

