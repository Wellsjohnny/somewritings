#+Title: Populacaoo Idosa SP

* Envelhecimento na perspectiva dos distritos
  [[./imgs/from_seade/evolucao_idade_media_distritos_sp.jpg]]
  Nas periferia a idade média é menor que a dos distritos centrais.
  Pela previsão para 2030 observa-se que os distritos periféricos
  envelhecem juntamente com os centrais.


* Sobre ferramentas de inform ática utilizadas 
  O pacote sf dispensa, sp e o gdal[sobre-sf-sp-gdal]. O sp porque ele extende o sp e o gdal porque
  ele interage com ele.  


  #+Name R env setup
  #+BEGIN_SRC R :session s1 :results output :exports code
      cranRepoUrl <- "http://cran.us.r-project.org";
      Sys.setenv(
          "http_proxy" = "http://cid:cid@192.168.0.2:3128",
          "ftp_proxy" = "http://cid:cid@192.168.0.2:3128",
          "all_proxy" = "http://cid:cid@192.168.0.2:3128");
      #Sys.unsetenv("http_proxy");
      #Sys.unsetenv("ftp_proxy");  
      #Sys.unsetenv("all_proxy");  

      #pkgsToBeInstalled <- c("curl", "sf","tidyverse","rgeos",
      #   "raster","dplyr","spData","spDataLarge","mapview","leaflet",
      #   "tmap","leaflet","mapview","shiny","ggplot2", "stringr", "maptools");
    
      #install.packages(
      #             pkgsToBeInstalled,
      #             repo = cranRepoUrl,
      #             dependencies = TRUE)

  #+END_SRC

  #+RESULTS:


* Leitura do arquivo shapefile DISTRITOS
  #+Name downloads de arquivos necessarios
  #+BEGIN_SRC R :session s1 :results output :exports code
 
      #zipFileUrl = "http://dados.prefeitura.sp.gov.br/dataset/af41e7c4-ae27-4bfc-9938-170151af7aee/resource/9e75c2f7-5729-4398-8a83-b4640f072b5d/download/layerdistrito.zip";
      #zipFileName = "layerdistrito.zip";
      #zipFileDestfile = paste(shpFilesDir,zipFileName, sep="/");      
      zipFileOutDir = paste( shpFilesDir, "LAYER_DISTRITO", sep="/");  
      #download.file(zipFileUrl,zipFileDestfile);
      #unzip(zipFileDestfile, exdir=shpFilesDir);
      
      shpFilesDir = paste(getwd(),"shapefiles",sep="/");      
      csvFilesDir = paste(getwd(),"csvfiles",sep="/");

      filePath_shpFileDISTRITO = paste(zipFileOutDir,"DEINFO_DISTRITO.shp", sep="/")
      filePath_DadosDoMapa = paste(csvFilesDir,"dados_do_mapa.csv", sep="/")
      print(filePath_DadosDoMapa)
      print(filePath_shpFileDISTRITO)
  #+END_SRC

  #+RESULTS:
  : [1] "/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/GIS/csvfiles/dados_do_mapa.csv"
  : [1] "/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/GIS/shapefiles/LAYER_DISTRITO/DEINFO_DISTRITO.shp"


* variaveis
 
   #+NAME vars globais
   #+BEGIN_SRC R :session s1 :results output :exports bouth  
      #starts code

   #+END_SRC

   #+RESULTS:
   : options:        X_POSSIBLE_NAMES=lat Y_POSSIBLE_NAMES=lng 
   : Cannot open data source c(7, 21, 80, 8, 75, 9, 85, 68, 42, 37, 15, 55, 82, 72, 81, 13, 10, 5, 18, 46, 22, 61, 66, 67, 65, 63, 27, 70, 31, 58, 88, 87, 73, 84, 1, 3, 2, 35, 36, 40, 47, 48, 50, 52, 54, 86, 33, 23, 6, 32, 71, 30, 29, 62, 60, 16, 14, 17, 20, 19, 26, 4, 74, 76, 34, 77, 39, 41, 83, 45, 79, 43, 11, 44, 57, 49, 53, 51, 38, 56, 89, 24, 25, 12, 78, 69, 64, 28, 59)
   : Error in CPL_read_ogr(dsn, layer, query, as.character(options), quiet,  : 
   :   Open failed.


* Gerando alguns mapas premilinares

  #+NAME mapas preliminares
  #+BEGIN_SRC R :session s1 :results output 
      library("sf")
      library("mapview")
      library("leaflet")
      library(ggplot2)
      library(ggmap)

      register_google(key = "AIzaSyAF4SsLUCcsaGGwVKQeGPWUQ9p-mKaA7Kw")
      locIPGG <- geocode("Praca Padre Aleixo Monteiro Mafra, 34")
      names(locIPGG)
      #location=c(-88.68,42.14)
      #mapIPGG <- get_map(location=c(-88.68,42.14))
                            #maptype = "satellite", 
                            #zoom = 6, 
                            #source = "google")
      #ggmap(mapIPGG)
      #m <- get_googlemap(center = c(lon = -95.3632715, lat = 29.7632836))
      #ggmap(m)
      #mDistritos <- leaflet() %>%
      #addTiles()  # Add default OpenStreetMap map tiles
      #mDistritos

      #mView <- mapview(mDistritos)
      #mView

      #df = data.frame(Lat = , Long = lgtIPGG)
      #leaflet(dfEquipSaude2017) %>% addCircles()
      #plot(shpSPDistritos);

      #https://pt.wikipedia.org/wiki/Zona_Leste_de_S%C3%A3o_Paulo
  #+END_SRC

  #+RESULTS:
  : Source : https://maps.googleapis.com/maps/api/geocode/json?address=Praca+Padre+Aleixo+Monteiro+Mafra,+34&key=xxx-mKaA7Kw
  : [1] "lon" "lat"
  : Source : https://maps.googleapis.com/maps/api/staticmap?center=29.763284,-95.363271&zoom=10&size=640x640&scale=2&maptype=terrain&key=xxx-mKaA7Kw
  : Error in aperm.default(map, c(2, 1, 3)) : 
  :   primeiro argumento invÃ¡lido: deve ser um array
  : AlÃ©m disso: Warning message:
  : In get_googlemap(center = c(lon = -95.3632715, lat = 29.7632836)) :
  :   HTTP 400 Bad Request
  : Error in ggmap(m) : objeto 'm' nÃ£o encontrado

  

* Conhecendo um pouco dos dados que serão apresentados no mapa
** Reconhecendo Regiao Leste Zona Leste1 e Zona Leste 2

   #+NAME   dataframes                   
   #+BEGIN_SRC R :session s1 :results output :exports bouth  
      library(sf)
      library(mapview)
      library(leaflet)
      library(ggplot2)
      library(ggmap)

      csvFilesDir = paste(getwd(),"csvfiles",sep="/");
      
      filePath_csvEquipSaude2017 = paste(csvFilesDir,"EQUIPAMENTOS_CSV_TEMA_SAUDE/DEINFO_SA_CADSAU_2007_Dados.csv", sep="/")
      filePath_csvFaixaEtarDist2018 = paste(csvFilesDir,"faixaEtariaPorDistritosPaulistasEm2018.csv",sep="/");

      dfEquipSaude2017 <- read.csv(filePath_csvEquipSaude2017,header = TRUE)
      #dfEquip
      dfFxEtar2018 <- read.csv(file = filePath_csvFaixaEtarDist2018,header = TRUE);
      st_shDistritos <- st_read(filePath_shpFileDISTRITO)
      #names(st_shDistritos)
      #nrow(dfEquipSaude2017)
      #nrow(dfFxEtar2018)

      shDistFxEt <-  st_shDistritos %>% left_join(dfFxEtar2018, by = "SIGLA_DIST") 

      #dfDadosDoMapa <- read.csv(filePath_DadosDoMapa, sep=";");
      #dfDadosDoMapa[,c(3,4)]
      #stDadosDoMapa <- st_read(dfDadosDoMapa, options=c("X_POSSIBLE_NAMES=lat","Y_POSSIBLE_NAMES=lng"))

      #str(dfDadosDoMapa)
      
      #st_crs(stDadosDoMapa)
      
      
      #summary(st_shDistritos)
      #names(st_shDistritos)
      #st_shDistritos[,c(4,7)]
      
      #mv <- mapview(shDistFxEt)
      #addStaticLabels(mv, shDistFxEt, 
      
      ggplot(data = shDistFxEt) + 
              geom_sf(aes(fill = X75Mais));
              #geom_sf_label(aes(label = X75Mais))


      #plot(st_shDistritos, axes = TRUE, cex.axes = 0.1)
      #plot(st_geometry(st_shDistritos), cex.axes = 0.1)
      #st_crs(st_shDistritos)
      #st_is_valid(st_shDistritos)

      #Calcula areas dos polignos
      #st_area(st_shDistritos)

      #calcula longitut lineas
      #st_length(st_shDistritos)

      #Colore o mapa
      #plot(st_shDistritos["NOME_DIST"],
      #                col=c("Dark Green","blue","yellow","black"))

      #plot(st_geometry(st_shDistritos, add = TRUE))
      #title(main = "Distritos de Sao Paulo", cex.main = 2.3)
      #text(1.2,3,"2fasdasfd",pos=5,col="red",cex=1)
      
      #legend("bottomleft", title = "Densidad")



      #dfFxEtar2018$Localidades
      
   #+END_SRC

   #+RESULTS:
   : Reading layer `DEINFO_DISTRITO' from data source `/home/wagner/wagnerdocri@gmail.com3/envs/env-dev/sources/somewritings/GIS/shapefiles/LAYER_DISTRITO/DEINFO_DISTRITO.shp' using driver `ESRI Shapefile'
   : Simple feature collection with 96 features and 9 fields
   : geometry type:  POLYGON
   : dimension:      XY
   : bbox:           xmin: 313434.8 ymin: 7343789 xmax: 360663.2 ymax: 7416202
   : epsg (SRID):    29193
   : proj4string:    +proj=utm +zone=23 +south +ellps=aust_SA +towgs84=-66.87,4.37,-38.52,0,0,0,0 +units=m +no_defs
   : Warning message:
   : Column `SIGLA_DIST` joining factors with different levels, coercing to character vector
   
   Existe o conceito de Região Leste, Zona Leste 1 e Zona Leste 2
   Distritos da Regiao Leste
   #+NAME distr da regiao zl1 e Zl2
   #+BEGIN_SRC R :session s1 :results output :exports bouth  
      #starts code
      library(dplyr)
      
      dfEqRLeste <- dfEquipSaude2017 %>% filter(REGIAO5 == "Leste")
      tbDistXREG05 <- table(dfEqRLeste$DISTRITO,dfEqRLeste$REGIAO8)
      dfDistXREG05 <- data.frame(tbDistXREG05)
      dfDistL1 <- dfDistXREG05 %>% dplyr::filter(Var2 == "Leste 1" & Freq != 0)
      dfDistL2 <- dfDistXREG05 %>% dplyr::filter(Var2 == "Leste 2" & Freq != 0)      
      #dfDistL1
      #dfDistL2
      #dfEquipSaudeRegLeste <- subset(dfEquipSaude2017, REGIAO5 == "Leste")
      dfFxEtar2018_Zl2 <- subset(dfFxEtar2018, zl == "ZL2")
      #names(dfFxEtar2018_Zl2)
      print(">>> $X75Mais");
      summary(dfFxEtar2018_Zl2$X75Mais)
      print(">>> X70a74")
      summary(dfFxEtar2018_Zl2$X70a74)
      print(">>> X65a69")
      summary(dfFxEtar2018_Zl2$X65a69)
      print(">>> $X60a64")
      summary(dfFxEtar2018_Zl2$X60a64)

      #distZl1 <- filter(dfFxEtarDist2018$zl, zl == "ZL1")
      #distZl1
   #+END_SRC

   #+RESULTS:
   #+begin_example
   [1] ">>> $X75Mais"
      Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1780    3006    3204    3369    3802    5704
   [1] ">>> X70a74"
      Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1590    2554    2886    3021    3375    4884
   [1] ">>> X65a69"
      Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      2346    3763    4447    4506    5221    6982
   [1] ">>> $X60a64"
      Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      3057    5101    6073    6084    6361    9224
   #+end_example

** idosos nas regiões   

   #+NAME idosos                   
   #+BEGIN_SRC R :session s1 :results output :exports bouth  
      #starts code
      library(dplyr)
      library(ggplot2)
      #View(dfFxEtar2018)
      #summary(dfFxEtar2018$X75Mais)
      #summary(dfFxEtar2018$Localidades)
                  
      print("");      
      dfFxEtar2018_Zl2[,c(1,17,18,19,20)]

      #dfFxEtar2018ZL1 <- dfFxEtar2018ZL1[order()]
      #dfFxEtar2018ZL1[,c(1,20)]
      #dfFxEtar2018ZL1
      #g <- dfFxEtar2018_Zl2 %>% ggplot(aes(Localidades,X75Mais)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
      #g
      #g <- dfFxEtar2018_Zl2 %>% ggplot(aes(Localidades,X70a74)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
      #g
      #g <- dfFxEtar2018_Zl2 %>% ggplot(aes(Localidades,X65a69)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
      #g
      #g <- dfFxEtar2018_Zl2 %>% ggplot(aes(Localidades,X60a64)) + geom_col() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
      #g
      
      #boxplot(
      #    X75Mais ~ Localidades, 
      #    data = dfFxEtar2018_Zl2,
      #    main = "Mais de 75 anos",
      #    xlab = "Num de Idosos Maiores de 75 anos",
      #    ylab = "Distritos da ZL2")

      #table(dfFxEtar2018$Localidades,dfFxEtar2018$X75Mais)
      #names(dfFxEtar2018)
      
      #dfFxEt2018 <- data.frame(table(dfFxEtar2018$Localidades,dfFxEtar2018$X75Mais))
      #dfFxEt2018

      #dfEquipSaudeZL1 <- subset(dfEquipSaude2017, REGIAO8 == "Leste 1")
      #levels(dfEquipSaudeZL1$DISTRITO)
   #+END_SRC

   #+RESULTS:
   #+begin_example
   [1] ""
             Localidades X60a64 X65a69 X70a74 X75Mais
   24       Cidade Lider   6180   4727   3219    3334
   25  Cidade Tiradentes   8745   6056   3557    3117
   28 Ermelino Matarazzo   5314   3999   2642    3200
   31         Guaianases   4279   3114   2007    2164
   32           Iguatemi   5360   3718   2292    2128
   35     Itaim Paulista   9224   6588   4355    4575
   36           Itaquera   9147   6982   4884    5704
   42      Jardim Helena   5101   3763   2554    2789
   46     Jose Bonifacio   6298   5221   3375    3349
   47            Lajeado   6361   4491   2886    3006
   58    Parque do Carmo   3057   2346   1590    1780
   65         Ponte Rasa   4933   3772   2755    3901
   75         Sao Mateus   7202   5448   3880    4853
   76         Sao Miguel   4057   3016   2253    3243
   77         Sao Rafael   5795   4306   2998    3121
   86        Vila Curuca   6073   4604   3246    3802
   89         Vila Jacui   6299   4447   2864    3204
   #+end_example
   



#+NAME shapefile with r
#+BEGIN_SRC R :session s1 :results output
#+END_SRC
#+NAME test
#+BEGIN_SRC R :session s1 :results output
    #install.packages("leaflet");
    #library(leaflet)
    library("sf")    # for static and interactive maps
    #library(sp);
    #world_sp = as(world, Class = "Spatial")
    #names(world_sp)
    #m <- leaflet() %>%
    #addTiles() %>%  # Add default OpenStreetMap map tiles
    #addMarkers(lng=174.768, lat=-36.852, popup="The birthplace of R")
    #print(m)  # Print the map

    spMun <- st_read(system.file("shapefiles/SP-MUN/35MUE250GC_SIR.shp", package="sf"))
    class(spMun);
#+END_SRC

#+RESULTS:
: Cannot open data source 
: Error in CPL_read_ogr(dsn, layer, query, as.character(options), quiet,  : 
:   Open failed.
: Erro: objeto 'spMun' nÃ£o encontrado


#+Name vignete sf
#+BEGIN_SRC R :results output
vignette(package = "sf") 
#+END_SRC

#+RESULTS:
#+begin_example
Vignettes in package âsfâ:

sf1                     1. Simple Features for R (source, html)
sf2                     2. Reading, Writing and Converting Simple
                        Features (source, html)
sf3                     3. Manipulating Simple Feature Geometries
                        (source, html)
sf4                     4. Manipulating Simple Features (source, html)
sf5                     5. Plotting Simple Features (source, html)
sf6                     6. Miscellaneous (source, html)

#+end_example










#+NAME list files
#+BEGIN_SRC R :session s1 :file imgs/img1.png :results value graphics
     Sys.getenv("R_LIBS_USER")
     .libPaths();
     library(tmap, lib.loc=RLibsDir)    # for static and interactive maps
     library(sf, lib.loc=RLibsDir)
#    library(raster)
#    library(dplyr)
#    library(spData)
#    library(spDataLarge)

#    library(leaflet) # for interactive maps
#    library(mapview) # for interactive maps
#    library(ggplot2) # tidyverse vis package
#    library(shiny)   # for web applications
    
#    list.files(path="kmzfiles", pattern="*.kmz", full.names=FALSE);
#    unzip(
#    zipfile="kmzfiles/Municipios_SP.kmz",
#    exdir="kmlfiles/");
    
#    list.files(path="kmlfiles", pattern="*.kml", full.names=FALSE);
     #tm_shape(nz) +
     #tm_fill()
#+END_SRC

#+RESULTS:
[[file:imgs/img1.png]]


#+NAME xxx
#+BEGIN_SRC R :session s1

#+END_SRC


#+begin_src R :file imgs/img1.png :results value graphics
  library(lattice)
  #library(maptools)
  print(xyplot(1:10 ~ 1:10))
#+end_src


#+begin_src R :file imgs/testeWWW.png :results value graphics
 library(lattice)
 print(xyplot(1:10 ~ 1:10))
#+end_src

#+RESULTS:
[[file:imgs/testeWWW.png]]



* Shape files
  s.ambiente.sp.gov.br/if/MAPA_SHAPE_ARQGIS.rar
  shop.forest-gis.com/downloads/ForestGIS_BaseLayers.zip



* Refs
[sobre-sf-sp-gdal]
https://geocompr.robinlovelace.net/spatial-class.html
https://cran.r-project.org/web/packages/sf/vignettes/sf2.html
https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-R.html
https://orgmode.org/manual
https://www.rdocumentation.org/
https://cran.r-project.org/web/packages/available_packages_by_name.html
https://gist.github.com/valentinitnelav/0f89f9cad2c7bcae8f989f0cd90bb395

http://www.gmapas.com/poligonos-ibge/poligonos-municipios-ibge-sao-paulo/Municipios_SP.kmz?attredirects=0&d=1

http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html
https://geocompr.robinlovelace.net/adv-map.html
[fn:mapview] https://github.com/r-spatial/mapview
